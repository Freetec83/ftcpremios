<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FTC Pr√™mios - Rifa Online</title>
<style>
  body{font-family:Arial,sans-serif;background:#f2f6ff;color:#003366;margin:0;padding:18px;}
  header{background:#fff;padding:10px;border-radius:10px;text-align:center;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
  .grade{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;max-width:980px;margin:8px auto}
  .numero{background:#fff;border-radius:8px;padding:10px;min-height:56px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:2px solid transparent;transition:transform .12s}
  .numero:hover{transform:translateY(-3px)}
  .disponivel{background:#eaf4ff;border-color:#4a8fe8}
  .reservado{background:#fff7e6;border-color:#ffb74d;cursor:default}
  .pago{background:#e8f7ff;border-color:#03a9f4;cursor:default}
  #formulario{max-width:420px;margin:12px auto;padding:12px;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);display:none}
  input,button,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin:6px 0;box-sizing:border-box;font-size:14px}
  button{background:#0b63d6;color:#fff;border:none;cursor:pointer}
  .small-btn{display:inline-block;padding:6px 10px;font-size:13px}
  #dadosSorteioBox{max-width:720px;margin:12px auto;padding:12px;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);text-align:left}
  #grupoWa{display:flex;flex-direction:column;gap:6px;background:#e6ffea;padding:10px;border-radius:8px;border:1px solid #9be59f}
  .highlight{font-weight:bold;color:#006600;background:#e0ffda;padding:8px;border-radius:6px;text-align:center}
  #adminArea{max-width:920px;margin:12px auto}
  #senhaContainer{background:#fff;padding:12px;border-radius:8px;border:1px solid #ddd}
  #adminPanel{display:none;background:#fff;padding:12px;border-radius:8px;margin-top:10px;border:1px solid #ddd}
  .row{display:flex;gap:8px}
  .col{flex:1}
  @media(max-width:700px){
    .grade{grid-template-columns:repeat(5,1fr)}
    .row{flex-direction:column}
  }
</style>
</head>
<body>
  <header>
    <img src="https://drive.google.com/uc?export=view&id=1n7U8qDkrcXc34synyHiwOlqV4a5azLVk" alt="FTC Pr√™mios" style="max-height:72px">
    <h2 style="margin:6px 0 0 0">Escolha seu n√∫mero da sorte!</h2>
  </header>

  <div id="gradeNumeros" class="grade" aria-live="polite"></div>

  <div id="formulario" aria-live="polite">
    <h3>Reservar n√∫mero <span id="numeroEscolhido"></span></h3>
    <input id="nome" placeholder="Seu nome completo" autocomplete="name">
    <input id="email" placeholder="Seu e-mail" type="email" autocomplete="email">
    <input id="contato" placeholder="Seu WhatsApp (ex: +5511999998888)" autocomplete="tel">
    <button onclick="enviarReserva()">Confirmar Reserva</button>
    <p id="mensagem" style="margin-top:8px"></p>

    <div id="aposReserva" style="display:none;margin-top:12px">
      <div id="grupoWa" >
        <a id="linkGrupo" href="#" target="_blank" rel="noopener">Entrar no grupo da rifa</a>
        <div class="highlight">PAGUE POR AQUI A SUA APOSTA E BOA SORTE</div>
      </div>

      <div style="margin-top:10px;">
        <p style="margin:6px 0 4px 0"><strong>Mensagem pronta para enviar ao organizador</strong></p>
        <textarea id="mensagemPronta" rows="5" readonly style="width:100%;"></textarea>
        <div class="row" style="margin-top:8px">
          <div class="col"><button onclick="abrirWhatsapp()">Gerar mensagem no WhatsApp</button></div>
          <div class="col"><button onclick="copiarMensagem()" style="background:#4caf50">Copiar mensagem</button></div>
        </div>
      </div>
    </div>
  </div>

  <div id="dadosSorteioBox" aria-live="polite">
    <h3>üì¢ Informa√ß√µes do Sorteio (p√∫blico)</h3>
    <p><strong>N¬∞ Sorteio:</strong> <span id="infoNumero">--</span></p>
    <p><strong>Data/Hora:</strong> <span id="infoDataHora">--</span></p>
    <p><strong>Valor:</strong> <span id="infoValor">--</span></p>
    <p><strong>Pr√™mio:</strong> <span id="infoPremio">--</span></p>
  </div>

  <div id="adminArea">
    <div id="senhaContainer">
      <h3>Painel Administrativo</h3>
      <input id="senhaAdmin" placeholder="Digite a senha do painel (ex: 8378)">
      <div class="row" style="margin-top:8px">
        <div class="col"><button onclick="entrarAdmin()">Entrar</button></div>
        <div class="col"><button onclick="carregarDadosPublicos()">Atualizar agora</button></div>
      </div>
      <p id="msgSenha" style="color:red;margin-top:8px"></p>
    </div>

    <div id="adminPanel">
      <h3>√Årea Admin</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <label>N¬∞ Sorteio:
            <input id="adminInputNumero" placeholder="N√∫mero do sorteio">
          </label>
        </div>
        <div>
          <label>Data/Hora:
            <input id="adminInputDataHora" type="datetime-local" placeholder="">
          </label>
        </div>
        <div>
          <label>Valor:
            <input id="adminInputValor" placeholder="Ex: R$ 5,00">
          </label>
        </div>
        <div>
          <label>Pr√™mio:
            <input id="adminInputPremio" placeholder="Ex: TV 43''">
          </label>
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <div class="col"><button onclick="salvarDadosSorteio()">Salvar Dados do Sorteio</button></div>
        <div class="col"><button onclick="resetarReservasNaoPagas()" style="background:#ff9800">Resetar reservas N√ÉO pagas</button></div>
      </div>

      <div style="margin-top:8px" class="row">
        <div class="col"><button onclick="executarSorteio()" style="background:#d32f2f">Executar Sorteio (senha)</button></div>
        <div class="col"><button onclick="resetarRifaCompleta()" style="background:#9e9e9e">Resetar rifa completa</button></div>
      </div>

      <p id="msgSalvarDados" style="color:green;margin-top:8px"></p>
      <p id="msgSorteio" style="color:green;margin-top:6px"></p>
    </div>
  </div>

<script>
  // ---------------------------
  // Inicializa√ß√£o
  // ---------------------------
  let numeroSelecionadoRaw = null; // valor cru enviado ao servidor (ex: 1)
  let numeroSelecionadoDisplay = ""; // string formatada p/ UI (ex: "01")
  let ultimaReserva = null; // guardar√° dados da reserva retornada pelo servidor

  function inicializar() {
    google.script.run.withSuccessHandler(mostrarNumeros).listarNumeros();
    google.script.run.withSuccessHandler(popularDadosSorteio).dadosSorteio();
  }
  inicializar();

  // Atualiza periodicamente
  setInterval(()=> {
    google.script.run.withSuccessHandler(mostrarNumeros).listarNumeros();
    google.script.run.withSuccessHandler(popularDadosSorteio).dadosSorteio();
  }, 3000);

  // ---------------------------
  // Util: normalizar status (remove acentos e case-insensitive)
  // ---------------------------
  function normalizeText(str) {
    if (!str && str !== 0) return '';
    return String(str).normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
  }

  // ---------------------------
  // Mostrar grade de n√∫meros
  // ---------------------------
  function mostrarNumeros(dados) {
    const c = document.getElementById('gradeNumeros');
    c.innerHTML = '';
    if (!dados || !dados.length) {
      c.innerHTML = '<p>Sem n√∫meros na planilha.</p>';
      return;
    }
    dados.forEach(item => {
      const div = document.createElement('div');
      div.className = 'numero';
      const rawNum = item.numero;
      const displayNum = String(rawNum).padStart(2,'0');
      const statusRaw = item.status || 'Dispon√≠vel';
      const statusNorm = normalizeText(statusRaw);

      if (statusNorm.indexOf('disp') !== -1 || statusNorm === '') div.classList.add('disponivel');
      else if (statusNorm.indexOf('reserv') !== -1) div.classList.add('reservado');
      else if (statusNorm.indexOf('pag') !== -1) div.classList.add('pago');

      div.innerHTML = `<div style="font-size:18px"><strong>${displayNum}</strong></div><div style="font-size:12px;margin-top:6px">${statusRaw}</div>`;

      // armazenar atributo com o n√∫mero cru (√∫til para a√ß√µes)
      div.dataset.numRaw = rawNum;

      // comportamento ao clicar de acordo com status (Dispon√≠vel / Reservado / Pago)
      if (statusNorm.indexOf('disp') !== -1 || statusNorm === '') {
        div.onclick = () => selecionarNumero(rawNum);
      } else if (statusNorm.indexOf('reserv') !== -1) {
        div.onclick = () => {
          // Prompt r√°pido para senha (Op√ß√£o A)
          const s = prompt('Senha para liberar o n√∫mero (4 d√≠gitos):');
          if (s === null) return;
          google.script.run.withSuccessHandler(res=>{
            alert(res.mensagem || (res.sucesso ? 'N√∫mero liberado' : 'Erro'));
            carregarDadosPublicos();
          }).resetNumeroIndividual(rawNum, s);
        };
      } else if (statusNorm.indexOf('pag') !== -1) {
        div.onclick = () => {
          alert('Esse n√∫mero j√° est√° pago.');
        };
      }

      c.appendChild(div);
    });
  }

  // ---------------------------
  // Selecionar e reservar
  // ---------------------------
  function selecionarNumero(num) {
    // num √© o valor cru vindo do sheet (ex: 1)
    numeroSelecionadoRaw = num;
    numeroSelecionadoDisplay = String(num).padStart(2,'0');
    document.getElementById('numeroEscolhido').innerText = numeroSelecionadoDisplay;
    document.getElementById('formulario').style.display = 'block';
    document.getElementById('mensagem').innerText = '';
    document.getElementById('aposReserva').style.display = 'none';
    setTimeout(()=>{ window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' }); }, 200);
  }

  function enviarReserva(){
    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    const contato = document.getElementById('contato').value.trim();
    if (!nome || !email || !contato) {
      document.getElementById('mensagem').style.color = 'red';
      document.getElementById('mensagem').innerText = 'Preencha todos os campos!';
      return;
    }
    if (numeroSelecionadoRaw === null) {
      document.getElementById('mensagem').style.color = 'red';
      document.getElementById('mensagem').innerText = 'Selecione um n√∫mero antes de reservar.';
      return;
    }

    document.getElementById('mensagem').style.color = 'black';
    document.getElementById('mensagem').innerText = 'Enviando reserva...';

    // ENVIAR O VALOR CRU (n√£o o com zero √† esquerda) para o servidor
    google.script.run.withSuccessHandler(res => {
      if (!res) {
        document.getElementById('mensagem').style.color = 'red';
        document.getElementById('mensagem').innerText = 'Erro inesperado.';
        return;
      }
      document.getElementById('mensagem').style.color = res.success ? 'green' : 'red';
      document.getElementById('mensagem').innerText = res.message || '';
      if (res.success) {
        ultimaReserva = res.reserva || null;
        // Preenche √°rea p√≥s-reserva com link do grupo e mensagem pronta
        document.getElementById('linkGrupo').href = res.grupoWhatsapp || 'https://chat.whatsapp.com/KzozjpPbC3UHIIEkTYuQrg';
        document.getElementById('mensagemPronta').value = criarMensagemPronta(res.reserva);
        document.getElementById('aposReserva').style.display = 'block';
      } else {
        document.getElementById('aposReserva').style.display = 'none';
      }
      // atualizar grade
      google.script.run.withSuccessHandler(mostrarNumeros).listarNumeros();
      google.script.run.withSuccessHandler(popularDadosSorteio).dadosSorteio();
    }).reservarNumero(numeroSelecionadoRaw, nome, email, contato);
  }

  function criarMensagemPronta(reserva) {
    if (!reserva) return '';
    return `Ol√°! Acabei de reservar um n√∫mero na rifa.\n\nN√∫mero: ${reserva.numero}\nC√≥digo: ${reserva.codigo}\nNome: ${reserva.nome}\nE-mail: ${reserva.email}\nWhatsApp: ${reserva.contato}\n\nFavor confirmar instru√ß√µes de pagamento.`;
  }

  // Abre WhatsApp com mensagem pronta (API sem n√∫mero, usu√°rio escolhe destinat√°rio)
  function abrirWhatsapp() {
    const texto = encodeURIComponent(document.getElementById('mensagemPronta').value || '');
    const url = 'https://api.whatsapp.com/send?text=' + texto;
    window.open(url, '_blank');
  }

  function copiarMensagem() {
    const txt = document.getElementById('mensagemPronta').value || '';
    navigator.clipboard.writeText(txt).then(()=> {
      alert('Mensagem copiada! Cole no WhatsApp para enviar ao organizador.');
    }).catch(()=> {
      alert('N√£o foi poss√≠vel copiar automaticamente. Selecione e copie manualmente.');
    });
  }

  // ---------------------------
  // Dados do sorteio (p√∫blico)
  // ---------------------------
  function popularDadosSorteio(info) {
    if (!info) return;
    document.getElementById('infoNumero').innerText = info.numeroSorteio || '--';
    // Se for objeto Date, toLocaleString; se for string, exibir como veio
    try {
      const l = info.dataHora;
      if (l instanceof Date) document.getElementById('infoDataHora').innerText = l.toLocaleString();
      else document.getElementById('infoDataHora').innerText = l || '--';
    } catch(e){
      document.getElementById('infoDataHora').innerText = info.dataHora || '--';
    }
    document.getElementById('infoValor').innerText = info.valor || '--';
    document.getElementById('infoPremio').innerText = info.premio || '--';
    // tamb√©m preenche inputs admin se estiver vis√≠vel
    if (document.getElementById('adminInputNumero')) {
      document.getElementById('adminInputNumero').value = info.numeroSorteio || '';
      try {
        if (info.dataHora) {
          const d = new Date(info.dataHora);
          const local = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
          document.getElementById('adminInputDataHora').value = local;
        }
      } catch(e){}
      document.getElementById('adminInputValor').value = info.valor || '';
      document.getElementById('adminInputPremio').value = info.premio || '';
    }
  }

  // ---------------------------
  // Admin: entrar (client-side show only)
  // ---------------------------
  function entrarAdmin() {
    const s = (document.getElementById('senhaAdmin').value || '').trim();
    if (!s) {
      document.getElementById('msgSenha').innerText = 'Digite a senha para acessar.';
      return;
    }
    if (s !== '8378') {
      document.getElementById('msgSenha').innerText = 'Senha incorreta.';
      return;
    }
    document.getElementById('msgSenha').innerText = '';
    document.getElementById('senhaContainer').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    carregarDadosPublicos();
  }

  // ---------------------------
  // Admin: salvar dados do sorteio
  // ---------------------------
  function salvarDadosSorteio() {
    const numero = document.getElementById('adminInputNumero').value || '';
    const dataHora = document.getElementById('adminInputDataHora').value || '';
    const valor = document.getElementById('adminInputValor').value || '';
    const premio = document.getElementById('adminInputPremio').value || '';
    document.getElementById('msgSalvarDados').innerText = 'Salvando...';
    google.script.run.withSuccessHandler(res=>{
      if (res && res.success) {
        document.getElementById('msgSalvarDados').innerText = 'Dados salvos com sucesso!';
        carregarDadosPublicos();
      } else {
        document.getElementById('msgSalvarDados').innerText = 'Erro ao salvar.';
      }
    }).salvarDadosSorteio(numero, dataHora, valor, premio);
  }

  // ---------------------------
  // Admin: executar sorteio (senha server-side)
  // ---------------------------
  function executarSorteio() {
    const s = prompt('Digite a senha do sorteio (4 d√≠gitos):');
    if (!s) return;
    document.getElementById('msgSorteio').innerText = 'Executando sorteio...';
    google.script.run.withSuccessHandler(res=>{
      if (!res) {
        document.getElementById('msgSorteio').style.color='red';
        document.getElementById('msgSorteio').innerText = 'Erro inesperado.';
        return;
      }
      if (res.erro) {
        document.getElementById('msgSorteio').style.color='red';
        document.getElementById('msgSorteio').innerText = res.erro;
      } else if (res.sucesso) {
        document.getElementById('msgSorteio').style.color='green';
        document.getElementById('msgSorteio').innerText = 'Sorteado: ' + res.numero;
        carregarDadosPublicos();
      } else {
        document.getElementById('msgSorteio').style.color='red';
        document.getElementById('msgSorteio').innerText = 'Resultado inesperado.';
      }
    }).realizarSorteio(s);
  }

  // ---------------------------
  // Admin: resetar reservas n√£o pagas
  // ---------------------------
  function resetarReservasNaoPagas() {
    if (!confirm('Resetar apenas reservas N√ÉO pagas? (os n√∫meros marcados como Pago ser√£o mantidos)')) return;
    google.script.run.withSuccessHandler(res=>{
      alert(res.message || 'Opera√ß√£o conclu√≠da.');
      carregarDadosPublicos();
    }).resetarReservasNaoPagas();
  }

  // ---------------------------
  // Admin: resetar rifa completa
  // ---------------------------
  function resetarRifaCompleta() {
    if (!confirm('Resetar toda a rifa (isso apagar√° todas as reservas e pagamentos)!')) return;
    google.script.run.withSuccessHandler(res=>{
      alert(res.message || 'Rifa resetada.');
      carregarDadosPublicos();
    }).resetarRifaCompleta();
  }

  // ---------------------------
  // Util: atualizar dados manualmente
  // ---------------------------
  function carregarDadosPublicos() {
    google.script.run.withSuccessHandler(popularDadosSorteio).dadosSorteio();
    google.script.run.withSuccessHandler(mostrarNumeros).listarNumeros();
  }

</script>
</body>
</html>
