<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rifa Online - Corrigido</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { border-collapse: collapse; width: 640px; max-width: 100%; margin-bottom: 20px; }
  td { border: 1px solid #aaa; padding: 8px; width: 48px; text-align: center; cursor: pointer; }
  td.disponivel { background: #d9f7d9; }
  td.reservado { background: #ffe4b3; cursor: not-allowed; }
  td.pago { background: #c8e6c9; cursor: not-allowed; }
  td.selecionado { outline: 3px solid #2e7d32; }
  button, input { padding: 8px; font-size: 14px; width: 100%; box-sizing: border-box; margin-top: 6px; }
  button:disabled { background: #999; cursor: not-allowed;}
  #mensagem { margin-top: 10px; font-weight: bold; }
  #painelOrganizador { margin-top: 20px; }
</style>
</head>
<body>

<h1>Rifa Online</h1>

<table id="gridNumeros" aria-label="grade de números"></table>

<form id="formReserva" onsubmit="return reservarNumero()">
  <input type="hidden" id="numeroSelecionado" />
  <label for="nome">Nome</label>
  <input type="text" id="nome" required />
  <label for="email">Email</label>
  <input type="email" id="email" required />
  <label for="telefone">Telefone</label>
  <input type="text" id="telefone" required />
  <button type="submit" id="btnReservar" disabled>Reservar Número</button>
</form>

<div id="mensagem"></div>

<div class="pix" id="pixContainer" style="display:none;">
  <h3>Pagamento via PIX</h3>
  <img src="1000341679.jpg" alt="QR Code PIX" style="max-width: 320px; width: 100%; height:auto;" />
  <p>Código de venda: <span id="codigoVenda"></span></p>
</div>

<button id="btnSortear" disabled>Sortear Número</button>
<div id="resultadoSorteio" style="margin-top:20px; font-weight: bold; color: green;"></div>

<hr />
<div id="painelOrganizador">
  <h3>Painel do Organizador</h3>
  <input id="senhaInput" placeholder="Digite a senha" type="password" />
  <button id="btnLogin">Entrar</button>
  <div id="areaPainel" style="display:none;">
    <button id="btnReset">Resetar Rifa</button>
    <div id="listaReservas"></div>
  </div>
</div>

<script>
  const SENHA_ADMIN = '8378';
  let autorizado = false;
  let reservas = {};
  let pagos = {};
  let numeroSelecionado = null;

  const grid = document.getElementById('gridNumeros');
  const btnReservar = document.getElementById('btnReservar');
  const inputNumero = document.getElementById('numeroSelecionado');
  const nomeInput = document.getElementById('nome');
  const emailInput = document.getElementById('email');
  const telefoneInput = document.getElementById('telefone');
  const mensagem = document.getElementById('mensagem');
  const pixContainer = document.getElementById('pixContainer');
  const codigoVendaElem = document.getElementById('codigoVenda');
  const btnSortear = document.getElementById('btnSortear');
  const resultadoSorteio = document.getElementById('resultadoSorteio');
  const senhaInput = document.getElementById('senhaInput');
  const btnLogin = document.getElementById('btnLogin');
  const areaPainel = document.getElementById('areaPainel');
  const listaReservas = document.getElementById('listaReservas');

  function renderTable() {
    let html = '<tr>';
    for(let i=0; i<100; i++){
      const numStr = String(i).padStart(2, '0');
      let cls = 'disponivel';
      if(pagos[numStr]) cls = 'pago';
      else if(reservas[numStr]) cls = 'reservado';
      html += `<td class="${cls}" data-num="${numStr}">${numStr}</td>`;
      if ((i+1) % 10 === 0 && i !== 99) {
        html += '</tr><tr>';
      }
    }
    html += '</tr>';
    grid.innerHTML = html;
  }

  function carregarEstado() {
    reservas = JSON.parse(localStorage.getItem('rifaReservas') || '{}');
    pagos = JSON.parse(localStorage.getItem('rifaPagos') || '{}');
  }

  function salvarEstado() {
    localStorage.setItem('rifaReservas', JSON.stringify(reservas));
    localStorage.setItem('rifaPagos', JSON.stringify(pagos));
  }

  function init() {
    carregarEstado();
    renderTable();

    grid.addEventListener('click', (e) => {
      if(e.target.tagName !== 'TD') return;
      const num = e.target.dataset.num;
      if(reservas[num] || pagos[num]) return;
      numeroSelecionado = num;
      inputNumero.value = num;
      btnReservar.disabled = false;
      pixContainer.style.display = 'none';
      mensagem.textContent = '';
      grid.querySelectorAll('.selecionado').forEach(td => td.classList.remove('selecionado'));
      e.target.classList.add('selecionado');
    });

    btnLogin.onclick = () => {
      if(senhaInput.value.trim() === SENHA_ADMIN){
        autorizado = true;
        areaPainel.style.display = 'block';
        senhaInput.value = '';
        carregarPainel();
        alert('Senha correta. Painel aberto!');
      } else {
        alert('Senha incorreta');
      }
    };

    document.getElementById('formReserva').onsubmit = (e) => {
      e.preventDefault();
      reservarNumero();
      return false;
    };

    document.getElementById('btnReset').onclick = () => {
      if(!autorizado) return alert('Acesso negado');
      if(confirm('Deseja resetar a rifa?')){
        reservas = {};
        pagos = {};
        salvarEstado();
        renderTable();
        carregarPainel();
        resultadoSorteio.textContent = '';
      }
    };

    btnSortear.onclick = () => {
      if(!autorizado) return alert('Acesso negado');
      if(Object.keys(pagos).length === 0){
        resultadoSorteio.textContent = 'Nenhum número pago para sortear';
        return;
      }
      const sorteado = Object.keys(pagos)[Math.floor(Math.random() * Object.keys(pagos).length)];
      resultadoSorteio.textContent = 'Vencedor: ' + sorteado;
    };
  }

  function reservarNumero() {
    if(!numeroSelecionado){
      mensagem.textContent = 'Selecione um número antes de reservar.';
      return false;
    }
    const nome = nomeInput.value.trim();
    const email = emailInput.value.trim();
    const telefone = telefoneInput.value.trim();
    if(!nome || !email || !telefone){
      mensagem.textContent = 'Preencha nome, email e telefone.';
      return false;
    }
    if(reservas[numeroSelecionado] || pagos[numeroSelecionado]){
      mensagem.textContent = 'Número já reservado ou pago.';
      return false;
    }

    const codigoVenda = 'RIF-' + numeroSelecionado + '-' + Date.now().toString(36).toUpperCase();
    reservas[numeroSelecionado] = {nome, email, telefone, timestamp: Date.now(), codigoVenda};
    salvarEstado();
    renderTable();
    document.getElementById('formReserva').reset();
    btnReservar.disabled = true;
    numeroSelecionado = null;

    // Enviar para grupo WhatsApp
    const msg = `Reserva de rifa
Número: ${numeroSelecionado}
Nome: ${nome}
Email: ${email}
Telefone: ${telefone}
Código de Venda: ${codigoVenda}`;
    window.open('https://wa.me/5531999999999?text=' + encodeURIComponent(msg), '_blank');

    pixContainer.style.display = 'block';
    codigoVendaElem.textContent = codigoVenda;
    mensagem.textContent = 'Número reservado, aguarde pagamento.';
    return false;
  }

  function carregarPainel(){
    listaReservas.innerHTML = '';
    for(const num in reservas){
      if(!pagos[num]) {
        const r = reservas[num];
        listaReservas.innerHTML += `<div>Num ${num} &bull; ${r.nome} &bull; ${r.email} &bull; ${r.telefone} 
          <button onclick="confirmarPagamento('${num}')">Confirmar Pagamento</button> &bull; Código: ${r.codigoVenda}</div>`;
      }
    }
    btnSortear.disabled = Object.keys(pagos).length === 0;
  }

  function confirmarPagamento(num){
    if(!autorizado) return alert('Acesso negado');
    pagos[num] = reservas[num];
    delete reservas[num];
    salvarEstado();
    carregarPainel();
    renderTable();
    mensagem.textContent = 'Pagamento confirmado para número ' + num;
  }

  window.confirmarPagamento = confirmarPagamento;

  init();
</script>

</body>
</html>
