<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FTC Pr√™mios ‚Äî A√á√ÉO PREMIADA C/ SORTEIO P√öBLICO - ONLINE (Black & Gold)</title>
<style>
/* ===========================
   THEME + CORE COLORS (FINAL)
   =========================== */
:root{
  --bg:#070708;
  --panel:#0f0f10;
  --card:#151617;
  --text:#eae8e3;
  --muted:#bfb8aa;
  --gold-1:#ffce00;   /* vencedor - dourado forte (B) */
  --gold-2:#d9a800;
  --gold-glow: 0 14px 40px rgba(255,206,0,0.35);
  --available:#d1e7d1; /* dispon√≠vel (neutro esverdeado) */
  --reserved:#f79c2f;  /* reservado (laranja forte) */
  --paid:#1f75ff;      /* pago (azul real) */
  --danger:#c62828;
  --glass: rgba(255,255,255,0.02);
  --card-border: rgba(255,255,255,0.03);
  --transition: 160ms ease;
}

/* Base */
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;
  background:linear-gradient(180deg,var(--bg), #050505);
  color:var(--text);padding:20px;-webkit-font-smoothing:antialiased;
}

/* Header */
header{
  display:flex;align-items:center;gap:16px;
  background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:14px;border-radius:12px;border:1px solid var(--card-border);
  max-width:1200px;margin:0 auto 16px;box-shadow:0 10px 30px rgba(0,0,0,0.6);
}
header img{height:62px;border-radius:10px}
header h1{margin:0;font-size:20px;color:var(--gold-1);letter-spacing:0.4px}
header p{margin:0;color:var(--muted);font-size:13px}

/* Panel J..Q */
.panel{max-width:1200px;margin:16px auto;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{
  background:linear-gradient(180deg,var(--panel),var(--card));
  padding:14px;border-radius:12px;border:1px solid var(--card-border);
  box-shadow: 0 12px 28px rgba(0,0,0,0.6);
}
.card .label{font-size:13px;color:var(--muted)}
.card .value{font-size:18px;font-weight:800;color:var(--text);margin-top:6px}
.big{grid-column:span 2}
.highlight{border-left:4px solid var(--gold-2);background:linear-gradient(180deg, rgba(217,168,80,0.03), rgba(217,168,80,0.01))}

/* Sorteio p√∫blico */
#sorteioPublico .title{font-size:13px;color:var(--muted);margin-bottom:6px}
#numeroAnimado{font-size:56px;font-weight:900;color:var(--gold-1);letter-spacing:1px;text-shadow: 0 6px 24px rgba(255,206,0,0.12)}

#sorteioPublico{
  margin:0 auto;
  text-align:center;
  width:100%;
  max-width:900px;
}

/* Grade */
.grade{
  display:grid;grid-template-columns:repeat(10,1fr);gap:12px;max-width:1200px;margin:18px auto;
}
.numero{
  min-height:72px;border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  border:1px solid var(--card-border);color:var(--text);transition:transform var(--transition),box-shadow var(--transition),opacity var(--transition);
  position:relative;overflow:visible;
}
.numero:hover{transform:translateY(-6px);box-shadow:0 20px 50px rgba(0,0,0,0.6)}

/* States */
.disponivel{ background: linear-gradient(180deg, var(--available), rgba(255,255,255,0.01)); color:#052b07; cursor:pointer; border-color: rgba(34,139,34,0.12) }
.reservado{ background: linear-gradient(180deg, rgba(247,156,47,0.06), rgba(247,156,47,0.03)); border-color: rgba(247,156,47,0.12); color: #2b1a00; }
.pago{ background: linear-gradient(180deg, rgba(31,117,255,0.06), rgba(31,117,255,0.03)); border-color: rgba(31,117,255,0.12); color:#031a4a; }
.vencedor{
  background: linear-gradient(180deg, var(--gold-1), var(--gold-2));
  border:2px solid rgba(255,206,0,0.95);
  color:#0a0a0a; box-shadow: var(--gold-glow);
  transform: translateY(-4px);
}

/* blocked visual */
.blocked{ opacity:0.45; pointer-events:none }

/* Paid animation (check pulse) */
@keyframes paidPop {
  0% { transform: scale(0.94); opacity:0.0; }
  40% { transform: scale(1.06); opacity:1; }
  100% { transform: scale(1); opacity:1; }
}
.paid-anim{ animation: paidPop 680ms cubic-bezier(.2,.9,.3,1); box-shadow: 0 8px 30px rgba(31,117,255,0.12); }

/* Winner pulse during raffle (strong) */
@keyframes winnerPulseFast {
  0% { transform: translateY(-2px) scale(1); box-shadow: 0 10px 30px rgba(255,206,0,0.18); }
  50% { transform: translateY(-6px) scale(1.06); box-shadow: 0 28px 60px rgba(255,206,0,0.28); }
  100% { transform: translateY(-2px) scale(1); box-shadow: 0 10px 30px rgba(255,206,0,0.18); }
}
.pulse{ animation: winnerPulseFast 700ms ease-in-out infinite; }

/* small badge when paid */
.numero .badge {
  position:absolute; top:8px; right:8px; background:var(--paid); color:#fff; font-size:11px; padding:4px 6px; border-radius:100px;
  border:1px solid rgba(255,255,255,0.06);
}

/* Form & buttons */
#formulario{ max-width:520px;margin:18px auto;padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border:1px solid var(--card-border) }
input,textarea,select,button{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); margin:8px 0; background:transparent; color:var(--text) }
button.btn{ background: linear-gradient(180deg, var(--gold-1), var(--gold-2)); border:none; color:#070707; font-weight:800; cursor:pointer }
button.secondary{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }
.groupBtn{ display:inline-block; padding:10px 14px; border-radius:8px; background:#25D366; color:#fff; text-decoration:none; }

/* Admin */
#adminPanel{ max-width:1200px; margin:18px auto 60px auto; padding:12px; border-radius:10px }
.admin-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }

/* Responsive */
@media(max-width:960px){
  .panel{ grid-template-columns:repeat(2,1fr) }
  .grade{ grid-template-columns:repeat(5,1fr) }
  .admin-grid{ grid-template-columns:repeat(2,1fr) }
}
</style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/dBoHN6K.png" alt="FTC Pr√™mios">
    <div>
      <h1>FTC Pr√™mios ‚Äî A√á√ÉO PREMIADA C/ SORTEIO P√öBLICO - ONLINE</h1>
      <p style="margin-top:6px;color:var(--muted)">Clique em um n√∫mero dispon√≠vel para reservar; bloqueio autom√°tico ao atingir a meta.</p>
    </div>
  </header>

  <div class="panel" aria-live="polite">
    <div class="card big highlight">
      <div class="label">üéâ N√∫mero Sorteado (J)</div>
      <div id="infoJ" class="value">--</div>
    </div>
    <div class="card">
      <div class="label">üè∑Ô∏è C√≥digo do Ganhador (K)</div>
      <div id="infoK" class="value">--</div>
    </div>
    <div class="card">
      <div class="label">üî¢ N¬∫ Sorteio (L)</div>
      <div id="infoL" class="value">--</div>
    </div>
    <div class="card">
      <div class="label">üí∞ Valor por N¬∫ (M)</div>
      <div id="infoM" class="value">--</div>
    </div>

    <div class="card"><div class="label">‚è±Ô∏è Data/Hora (N)</div><div id="infoN" class="value">--</div></div>
    <div class="card"><div class="label">üéÅ Pr√™mio (O)</div><div id="infoO" class="value">--</div></div>
    <div class="card"><div class="label">üìà Meta de Vendas (P)</div><div id="infoP" class="value">--</div></div>
    <div class="card"><div class="label">üßæ Total N¬∫ Vendidos (Q)</div><div id="infoQ" class="value">--</div></div>
  </div>

  <div id="sorteioPublico">
    <div id="numeroAnimado">00</div>
  </div>

   <div id="formulario" style="display:none" aria-live="polite">
    <h3 style="margin:0 0 8px 0">Reservar n√∫mero <span id="numeroEscolhido" style="color:var(--gold-1)"></span></h3>
    <input id="nome" placeholder="Seu nome completo" autocomplete="name">
    <input id="email" placeholder="Seu e-mail" type="email" autocomplete="email">
    <input id="contato" placeholder="Seu WhatsApp (ex: +5511999998888)" autocomplete="tel">
    <div style="display:flex;gap:10px">
      <button id="btnEnviarReserva" class="btn" style="flex:1">Confirmar Reserva</button>
      <button id="btnCancelarReserva" type="button" class="secondary" style="width:140px">Cancelar</button>
    </div>
    <p id="mensagem" class="muted"></p>

    <div id="aposReservaCard" style="display:none;margin-top:12px;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))">
      <p style="margin:0 0 8px 0;font-weight:700;color:var(--gold-1)">Envie seu comprovante de pagamento no grupo</p>
      <p style="margin:2px 0;color:var(--text)"><strong>Chave PIX:</strong> <span id="pixKeyText">9ce163ce-4d97-425a-9a99-445802f3e871</span></p>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="copyPixBtn" class="btn" style="background:var(--gold-1);color:#070707;padding:8px">Copiar PIX</button>
        <button id="instrBtn" class="secondary" style="width:160px">Instru√ß√µes</button>
      </div>
      <a id="grupoLink" href="https://chat.whatsapp.com/KzozjpPbC3UHIIEkTYuQrg" target="_blank" rel="noopener" class="groupBtn">Entrar no grupo</a>
    </div>
  </div>

<div id="areaRifa">

  <div id="gradeNumeros" class="grade" role="list" aria-live="polite"></div>

  <div id="adminPanel">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <input id="senhaAdmin" placeholder="Senha admin" style="flex:1;padding:10px;border-radius:8px">
      <button id="btnEntrarAdmin" class="btn" style="width:160px">Entrar Admin</button>
      <button id="btnAtualizarPublico" class="secondary" style="width:160px">Atualizar agora</button>
    </div>

    <div id="adminArea" style="display:none">
      <h3 class="muted">Painel Administrativo (J ‚Üí Q)</h3>
      <div id="adminForm" class="admin-grid" style="margin-bottom:12px">
        <div><label class="muted">J - N√∫mero Sorteado</label><input id="adminJ" placeholder="00"></div>
        <div><label class="muted">K - C√≥digo do Ganhador</label><input id="adminK" placeholder="ABC"></div>
        <div><label class="muted">L - N¬∫ Sorteio</label><input id="adminL" placeholder="Ex: 01"></div>
        <div><label class="muted">M - Valor por N¬∫</label><input id="adminM" placeholder="Ex: R$ 5,00"></div>
        <div><label class="muted">N - Data/Hora</label><input id="adminN" type="datetime-local"></div>
        <div><label class="muted">O - Pr√™mio</label><input id="adminO" placeholder="Ex: TV 43''"></div>
        <div><label class="muted">P - Meta de Vendas</label><input id="adminP" placeholder="Ex: 100"></div>
        <div><label class="muted">Q - Total N¬∫ Vendidos</label><input id="adminQ" placeholder="Ex: 24"></div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button id="btnSalvarJQ" class="btn">Salvar J‚ÜíQ</button>
        <button id="btnResetReservas" class="secondary">Resetar reservas N√ÉO pagas</button>
        <button id="btnResetRifa" class="secondary">Resetar rifa completa</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <div style="flex:1"><label class="muted">Confirmar Pagamento (N√∫mero)</label><input id="confirmar-numero" placeholder="Ex: 24"></div>
        <div style="width:160px"><label class="muted">Senha</label><input id="confirmar-senha" placeholder="Senha admin"></div>
        <div style="width:160px;align-self:flex-end"><button id="btnConfirmarPagamento" class="btn">Confirmar Pagamento</button></div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button id="btnIniciarSorteio" class="btn" style="background:var(--danger)">Executar sorteio (p√∫blico)</button>
        <button id="btnRegistrarResultado" class="secondary">Registrar Resultado Manual</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="liberar-minutos" placeholder="Minutos (p.ex. 10)" style="width:160px;padding:8px;border-radius:6px">
        <input id="liberar-senha" placeholder="Senha admin" style="flex:1;padding:8px;border-radius:6px">
        <button id="btnLiberarReservas" class="btn" style="width:180px">Liberar reservas por N min</button>
        <button id="btnDesbloquear" class="secondary" style="width:140px">Remover override</button>
      </div>

      <div id="adminMsgs" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(function(){
  function pad(n){ return String(n).padStart(2,'0'); }
  function el(id){ return document.getElementById(id); }

  // elements
  const gradeEl = el('gradeNumeros');
  const formEl = el('formulario');
  const numeroEscolhidoEl = el('numeroEscolhido');
  const mensagemEl = el('mensagem');
  const btnEnviar = el('btnEnviarReserva');
  const btnCancelar = el('btnCancelarReserva');
  const aposReservaCard = el('aposReservaCard');
  const pixKeyText = el('pixKeyText');
  const copyPixBtn = el('copyPixBtn');
  const grupoLink = el('grupoLink');
  const instrBtn = el('instrBtn');

  const btnEntrarAdmin = el('btnEntrarAdmin');
  const senhaAdmin = el('senhaAdmin');
  const adminArea = el('adminArea');
  const btnAtualizarPublico = el('btnAtualizarPublico');
  const adminFields = { J: el('adminJ'), K: el('adminK'), L: el('adminL'), M: el('adminM'), N: el('adminN'), O: el('adminO'), P: el('adminP'), Q: el('adminQ') };
  const btnSalvarJQ = el('btnSalvarJQ');
  const btnResetReservas = el('btnResetReservas');
  const btnResetRifa = el('btnResetRifa');
  const btnConfirmarPagamento = el('btnConfirmarPagamento');
  const confirmarNumero = el('confirmar-numero');
  const confirmarSenha = el('confirmar-senha');
  const btnIniciarSorteio = el('btnIniciarSorteio');
  const btnRegistrarResultado = el('btnRegistrarResultado');
  const adminMsgs = el('adminMsgs');

  const btnLiberarReservas = el('btnLiberarReservas');
  const btnDesbloquear = el('btnDesbloquear');
  const liberarMinutos = el('liberar-minutos');
  const liberarSenha = el('liberar-senha');

  const sorteioPublico = el('sorteioPublico');
  const numeroAnimado = el('numeroAnimado');

  const PIX_DEFAULT = '9ce163ce-4d97-425a-9a99-445802f3e871';
  const GRUPO_LINK = 'https://chat.whatsapp.com/KzozjpPbC3UHIIEkTYuQrg';
  const STORAGE_KEY = 'ftc_premios_contact';
  let blockedByMeta = false;
  let numeroSelecionado = null;
  let rafflePulseTimer = null;

  grupoLink.href = GRUPO_LINK;
  pixKeyText.textContent = PIX_DEFAULT;

    // ================================================
  // üü° FUN√á√ÉO PARA EXIBIR SORTEIO PARA TODOS
  // ================================================
  function mostrarSorteioPublico() {
    sorteioPublico.style.display = 'block';
    sorteioPublico.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // abrir formul√°rio (clic√°vel somente se n√£o bloqueado)
  function abrirFormulario(num){
    if (blockedByMeta) { alert('Reservas temporariamente bloqueadas: meta de vendas atingida.'); return; }
    const reservedContact = localStorage.getItem(STORAGE_KEY);
    if(reservedContact){
      const ok=confirm('Este navegador j√° registrou uma reserva com um contato. Deseja continuar?');
      if(!ok) return;
    }
    numeroSelecionado=num;
    numeroEscolhidoEl.textContent=num;
    formEl.style.display='block';
    mensagemEl.textContent='';
    aposReservaCard.style.display='none';
    setTimeout(()=> window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth'}),200);
  }

  // cancelar
  btnCancelar.addEventListener('click', ()=>{
    formEl.style.display='none';
    numeroSelecionado=null;
    numeroEscolhidoEl.textContent='';
    mensagemEl.textContent='';
    aposReservaCard.style.display='none';
  });

  // copiar PIX
  copyPixBtn.addEventListener('click', ()=>{
    navigator.clipboard.writeText(pixKeyText.textContent||PIX_DEFAULT).then(()=>alert('PIX copiado!')).catch(()=>alert('Copie manualmente: '+pixKeyText.textContent));
  });

  // instru√ß√µes
  instrBtn.addEventListener('click',()=>alert('Abra sua carteira PIX, cole a chave e realize o pagamento. Em seguida envie o comprovante no grupo do WhatsApp.'));

  // enviar reserva
  btnEnviar.addEventListener('click', ()=>{
    const nome = el('nome').value.trim();
    const email = el('email').value.trim();
    const contato = el('contato').value.trim();
    if(!nome||!email||!contato){mensagemEl.style.color='red';mensagemEl.textContent='Preencha nome, e-mail e WhatsApp.';return;}
    if(!numeroSelecionado){mensagemEl.style.color='red';mensagemEl.textContent='Selecione um n√∫mero antes.';return;}
    mensagemEl.style.color='black';mensagemEl.textContent='Enviando reserva...';
    if(!window.google||!google.script||!google.script.run){mensagemEl.style.color='red';mensagemEl.textContent='Integra√ß√£o com Google Apps Script n√£o detectada.';return;}

    google.script.run.withSuccessHandler(res=>{
      if(!res){mensagemEl.style.color='red';mensagemEl.textContent='Erro inesperado.';return;}
      if(!res.success){mensagemEl.style.color='red';mensagemEl.textContent=res.message||'Erro ao reservar.';return;}
      mensagemEl.style.color='green';mensagemEl.textContent=res.message||'Reservado com sucesso!';
      try{localStorage.setItem(STORAGE_KEY,contato);}catch(e){}
      pixKeyText.textContent=res.pix||PIX_DEFAULT;
      grupoLink.href=GRUPO_LINK;
      aposReservaCard.style.display='block';
      atualizarGrade();
    }).reservarNumero(numeroSelecionado,nome,email,contato);
  });

  // render grade helpers
  function statusParaClasse(status){
    if(!status) return 'disponivel';
    const s = String(status).toLowerCase();
    if(s.indexOf('venced') !== -1) return 'vencedor';
    if(s.indexOf('reserv') !== -1) return 'reservado';
    if(s.indexOf('pag') !== -1) return 'pago';
    if(s.indexOf('dispon') !== -1 || s.indexOf('disp') !== -1) return 'disponivel';
    return 'disponivel';
  }

  function renderGrade(arr){
    gradeEl.innerHTML='';
    arr.forEach(d=>{
      const cls = statusParaClasse(d.status);
      const div = document.createElement('div');
      div.className='numero '+cls;
      div.setAttribute('data-numero',d.numero);
      div.textContent=d.numero;

      // add small badge for paid
      if(cls === 'pago'){
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = 'PAGO';
        div.appendChild(badge);
        // animate briefly
        div.classList.add('paid-anim');
        setTimeout(()=>div.classList.remove('paid-anim'),900);
      }

      if(!blockedByMeta && cls === 'disponivel') {
        div.addEventListener('click',()=>abrirFormulario(d.numero));
      } else {
        if(blockedByMeta && cls === 'disponivel') div.classList.add('blocked');
      }

      // if winner mark
      if(cls === 'vencedor') {
        // ensure winner style present; it will be animated during raffle via .pulse
        div.classList.add('vencedor');
      }

      gradeEl.appendChild(div);
    });
  }

  function renderDefaults(){const arr=[];for(let i=0;i<100;i++) arr.push({numero:pad(i),status:'Dispon√≠vel'});renderGrade(arr);}

  function atualizarGrade(){
    if(!window.google||!google.script||!google.script.run){renderDefaults();return;}
    google.script.run.withSuccessHandler(dados=>{
      renderGrade(dados&&dados.length?dados:[]);
    }).listarNumeros();
  }

  // DADOS J‚ÜíQ
  function atualizarDadosJQ(){
    if(!window.google||!google.script||!google.script.run) return;
    google.script.run.withSuccessHandler(info=>{
      if(!info) return;
      el('infoJ').textContent=info.J||'--';
      el('infoK').textContent=info.K||'--';
      el('infoL').textContent=info.L||'--';
      el('infoM').textContent=info.M||'--';
      el('infoN').textContent=info.N||'--';
      el('infoO').textContent=info.O||'--';
      el('infoP').textContent=info.P||'--';
      el('infoQ').textContent=info.Q||'--';

      // bloquear por meta: Q >= P (considera somente n√∫meros)
      const meta = Number((info.P||'').toString().replace(/[^\d]/g,'')) || 0;
      const total = Number((info.Q||'').toString().replace(/[^\d]/g,'')) || 0;
      blockedByMeta = (meta > 0 && total >= meta);

      if(adminArea.style.display!=='none'){
        const active = document.activeElement;
        const editing = Object.values(adminFields).includes(active);
        if(!editing){
          adminFields.J.value=info.J||'';
          adminFields.K.value=info.K||'';
          adminFields.L.value=info.L||'';
          adminFields.M.value=info.M||'';
          try{if(info.N){const d=new Date(info.N);adminFields.N.value=isNaN(d.getTime())?info.N:new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);}else adminFields.N.value='';}catch(e){adminFields.N.value=info.N||'';}
          adminFields.O.value=info.O||'';
          adminFields.P.value=info.P||'';
          adminFields.Q.value=info.Q||'';
        }
      }

      atualizarGrade();
    }).dadosJQ();
  }

  // ADMIN
  btnEntrarAdmin.addEventListener('click', ()=>{
    const s=senhaAdmin.value.trim();
    if(!s){alert('Digite a senha');return;}
    adminArea.style.display='block';
    atualizarDadosJQ();
  });

  btnAtualizarPublico.addEventListener('click', ()=>{ atualizarGrade(); atualizarDadosJQ(); });

  btnSalvarJQ.addEventListener('click', ()=>{
    const j=adminFields.J.value.trim();
    const k=adminFields.K.value.trim();
    const l=adminFields.L.value.trim();
    const m=adminFields.M.value.trim();
    const n=adminFields.N.value.trim();
    const o=adminFields.O.value.trim();
    const p=adminFields.P.value.trim();
    const q=adminFields.Q.value.trim();
    google.script.run.withSuccessHandler(res=>{
      if(res&&res.success){adminMsgs.textContent='Dados salvos com sucesso.'; atualizarDadosJQ();}
      else adminMsgs.textContent='Erro ao salvar.';
    }).salvarDadosSorteio(j||'',k||'',l||'',m||'',o||'',p||'',q||'');
  });

  btnResetReservas.addEventListener('click',()=>{
    if(!confirm('Resetar apenas reservas N√ÉO pagas?')) return;
    google.script.run.withSuccessHandler(res=>{alert(res.message||'Opera√ß√£o conclu√≠da.'); atualizarGrade(); atualizarDadosJQ();}).resetarReservasNaoPagas();
  });

  btnResetRifa.addEventListener('click',()=>{
    if(!confirm('Resetar toda a rifa (apaga reservas/pagamentos)?')) return;
    google.script.run.withSuccessHandler(res=>{alert(res.message||'Rifa resetada.'); atualizarGrade(); atualizarDadosJQ();}).resetarRifaCompleta();
  });

  btnConfirmarPagamento.addEventListener('click', ()=>{
    const num = confirmarNumero.value.trim();
    const senha = confirmarSenha.value.trim();
    if(!num||!senha){alert('Informe n√∫mero e senha');return;}
    google.script.run.withSuccessHandler(res=>{
      if(res&&res.sucesso){alert(res.mensagem||'Pagamento confirmado'); atualizarGrade(); atualizarDadosJQ();}
      else alert(res.mensagem||'Erro ao confirmar pagamento');
    }).confirmarPagamento(Number(num),senha);
  });

  // ---------- SORTEIO P√öBLICO (varia√ß√£o de velocidade, 60s) ----------
btnIniciarSorteio.addEventListener('click', () => {
  const senha = prompt('Senha admin:');
  if (!senha) return;

  // pega lista de pagos do servidor
  google.script.run.withSuccessHandler(pagos => {
    if(!pagos || pagos.length === 0) return alert('N√£o h√° n√∫meros pagos para sortear.');
    const pagosFmt = pagos.map(n => pad(n)); // ex: "03","24","99"

    // UI init
    sorteioPublico.style.display = 'block';
    numeroAnimado.textContent = '00';
    // cancel any previous raffle
    if (rafflePulseTimer) { clearTimeout(rafflePulseTimer); rafflePulseTimer = null; }
    document.querySelectorAll('.numero.pulse').forEach(n => n.classList.remove('pulse'));

    // configura√ß√£o
    const TOTAL_MS = 60000; // 60s total
    const start = Date.now();
    let lastTick = 0;

    // easing para variar velocidade: retorna delay em ms entre ticks dependendo do elapsed
    // come√ßa lento (300ms), acelera at√© 50ms no pico, depois desacelera para suspense final (~400ms)
    function dynamicDelay(elapsed) {
      const t = Math.min(1, elapsed / TOTAL_MS); // 0..1
      // vamos criar uma curva: slow (0-0.12) -> accelerate (0.12-0.45) -> very fast (0.45-0.85) -> slow end (0.85-1)
      if (t < 0.12) return 350;                    // inicio lento
      if (t < 0.45) return 200 - ( (t - 0.12) / (0.45 - 0.12) ) * 120; // 200 -> 80
      if (t < 0.85) return 80 - ( (t - 0.45) / (0.85 - 0.45) ) * 50;    // 80 -> 30 (muito r√°pido)
      // desacelera para final dramatico
      return 170 + ( (t - 0.85) / (1 - 0.85) ) * 230; // 170 -> ~400
    }

    // fun√ß√£o que executa um tick: mostra um paid aleat√≥rio e anima alguns payment-nodes
    function tick() {
      const elapsed = Date.now() - start;
      if (elapsed >= TOTAL_MS) {
        // final: escolhe vencedor definitivo (servidor)
        endRaffleAndRegister(pagosFmt);
        return;
      }

      // escolhe um random para mostrar no centro
      const chosen = pagosFmt[Math.floor(Math.random() * pagosFmt.length)];
      numeroAnimado.textContent = chosen;

      // anima alguns n√≥s pagos aleat√≥rios (pulse)
      document.querySelectorAll('.numero.pulse').forEach(n => n.classList.remove('pulse'));
      const pickCount = Math.min(5, pagosFmt.length);
      for (let i = 0; i < pickCount; i++) {
        const v = pagosFmt[Math.floor(Math.random() * pagosFmt.length)];
        const node = document.querySelector(`.numero[data-numero="${v}"]`);
        if (node) node.classList.add('pulse');
      }

      // schedule next tick com delay din√¢mico
      const delay = dynamicDelay(elapsed);
      lastTick = setTimeout(tick, delay);
      rafflePulseTimer = lastTick;
    }

    // finaliza: remove pulses, escolhe vencedor final e registra no servidor
    function endRaffleAndRegister(pagosFmt) {
      document.querySelectorAll('.numero.pulse').forEach(n => n.classList.remove('pulse'));
      // decis√£o final deve ser do servidor para evitar manipula√ß√£o: vamos escolher localmente a exibi√ß√£o,
      // mas em seguida chamar registrarResultadoSorteio(final) que grava no servidor e retorna confirma√ß√£o.
      const vencedor = pagosFmt[Math.floor(Math.random() * pagosFmt.length)];
      numeroAnimado.textContent = vencedor;
      // marca visualmente
      document.querySelectorAll('.numero.vencedor').forEach(n => n.classList.remove('vencedor'));
      const winnerNode = document.querySelector(`.numero[data-numero="${vencedor}"]`);
      if (winnerNode) winnerNode.classList.add('vencedor');

      // chama o servidor para registrar (servidor usa m√©todo seguro e grava em planilha)
      google.script.run.withSuccessHandler(res => {
        if (res && res.success) {
          alert('Sorteio registrado! Vencedor: ' + vencedor);
          atualizarGrade(); atualizarDadosJQ();
        } else {
          alert('Erro ao registrar resultado: ' + (res && res.message || 'erro servidor'));
          // opcional: re-sync grade
          atualizarGrade(); atualizarDadosJQ();
        }
      }).registrarResultadoSorteio(Number(vencedor));
    }

    // start ticking
    tick();

  }).listarPagos();
});

  btnRegistrarResultado.addEventListener('click', ()=>{
    const manualNum = prompt('Numero final (00..99):');
    if(!manualNum) return;
    google.script.run.withSuccessHandler(res=>{
      if(res&&res.success){alert('Resultado registrado: '+res.numero); atualizarDadosJQ(); atualizarGrade();}
      else alert('Erro registrar resultado.');
    }).registrarResultadoSorteio(manualNum);
  });

  // ADMIN: liberar reservas temporariamente / desbloquear
  btnLiberarReservas.addEventListener('click', ()=>{
    const mins = liberarMinutos.value.trim();
    const senha = liberarSenha.value.trim();
    if(!senha){alert('Informe a senha admin para liberar.');return;}
    google.script.run.withSuccessHandler(res=>{
      if(res && res.success){adminMsgs.textContent = res.message; atualizarDadosJQ(); atualizarGrade();}
      else adminMsgs.textContent = res.message || 'Erro ao liberar reservas.';
    }).liberarReservasTemporariamente(senha, mins || 10);
  });

  btnDesbloquear.addEventListener('click', ()=>{
    const senha = liberarSenha.value.trim();
    if(!senha){alert('Informe a senha admin para desbloquear.');return;}
    google.script.run.withSuccessHandler(res=>{
      if(res && res.success){adminMsgs.textContent = res.message; atualizarDadosJQ(); atualizarGrade();}
      else adminMsgs.textContent = res.message || 'Erro ao desbloquear.';
    }).desbloquearReservas(senha);
  });

  // inicial
  renderDefaults();
  atualizarGrade();
atualizarDadosJQ();
setInterval(atualizarGrade, 5000);
setInterval(atualizarDadosJQ, 7000);

  // debug
  window.ftc = { atualizarGrade, atualizarDadosJQ, renderDefaults };
})();

  // Mostrar painel p√∫blico
  const painel = document.getElementById("sorteioPublico");
  painel.style.display = "block";
  painel.scrollIntoView({ behavior: "smooth", block: "center" });

  const alvo = parseInt(res.numero, 10);
  const animado = document.getElementById("numeroAnimado");

  let tempoTotal = 60000; // 60s
  let tempoPassado = 0;

  function velocidadeVariavel() {
    // velocidade muda em 5 fases para quebrar padr√£o repetido
    const p = tempoPassado / tempoTotal;
    if (p < 0.15) return 40 + Math.random() * 25;    // r√°pido no in√≠cio
    if (p < 0.35) return 70 + Math.random() * 60;
    if (p < 0.60) return 120 + Math.random() * 110;
    if (p < 0.85) return 200 + Math.random() * 200;
    return 380 + Math.random() * 300;                // bem lento no final
  }

  function rodar() {
    const n = Math.floor(Math.random() * res.maximo) + 1;
    animado.textContent = n.toString().padStart(2, "0");
    tempoPassado += velocidade;

    if (tempoPassado >= tempoTotal) {
      animado.textContent = alvo.toString().padStart(2, "0");
      animado.style.color = "var(--gold-2)";
      animado.style.textShadow = "0 0 15px rgba(255,215,0,0.9)";
      return;
    }

    velocidade = velocidadeVariavel();
    setTimeout(rodar, velocidade);
  }

  let velocidade = velocidadeVariavel();
  rodar();

  let monitorSorteio = null;

function iniciarMonitorPublico() {
  if (monitorSorteio) clearInterval(monitorSorteio);

  monitorSorteio = setInterval(() => {
    google.script.run.withSuccessHandler(estado => {

      if (estado.status === 'RUNNING') {
        sorteioPublico.style.display = 'block';

        numeroAnimado.textContent =
          Math.floor(Math.random() * 100).toString().padStart(2, '0');

        if (Date.now() >= estado.fim) {
          google.script.run.finalizarSorteioPublico();
        }
      }

      if (estado.status === 'FINISHED') {
        clearInterval(monitorSorteio);
        numeroAnimado.textContent =
          String(estado.vencedor).padStart(2, '0');
        destacarVencedorNaGrade(estado.vencedor);
      }

    }).statusSorteioPublico();
  }, 1000);
}

document.addEventListener('DOMContentLoaded', () => {
  if (location.hash === '#sorteio') {
    const el = document.getElementById('sorteioPublico');
    if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
  }
});

document.addEventListener('DOMContentLoaded', () => {
  if (location.hash === '#sorteio') {
    const el = document.getElementById('sorteioPublico');
    if (el) {
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
});

  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const modoPublico = params.get('publico') === '1';

    if (modoPublico) {
      const sorteio = document.getElementById('sorteioPublico');
      if (sorteio) sorteio.style.display = 'block';

      const rifa = document.getElementById('areaRifa');
      if (rifa) rifa.style.display = 'none';

      if (typeof iniciarMonitorPublico === 'function') {
        iniciarMonitorPublico();
      }
    }
  });

</script>
</body>
</html>
