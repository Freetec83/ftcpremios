<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rifa Completa com Firebase</title>
<style>
  /* (mesmo estilo do seu projeto anterior) */
</style>
</head>
<body>

<h1>Rifa Completa com Painel e Roleta</h1>

<div id="loginSection">
  <label for="emailInput">E-mail do Admin:</label>
  <input type="email" id="emailInput" placeholder="Digite o e-mail do admin" />
  <label for="passwordInput">Senha do Admin:</label>
  <input type="password" id="passwordInput" placeholder="Digite a senha" />
  <button onclick="login()">Entrar no Painel</button>
  <p id="loginMsg" style="color:#f55;"></p>
</div>

<div id="adminPanel" style="display:none;">
  <h2>Painel Organizador</h2>
  <label>Número da Rifa
    <input type="text" id="raffleNumber" value="001" />
  </label>
  <label>Valor da Rifa (R$)
    <input type="number" step="0.01" id="raffleValue" value="10.00" />
  </label>
  <label>Data do Sorteio
    <input type="date" id="raffleDate" />
  </label>
  <label>Hora do Sorteio
    <input type="time" id="raffleTime" />
  </label>
  <button onclick="saveRaffleInfo()">Salvar Dados da Rifa</button>
  <button onclick="logout()">Sair do Painel</button>
</div>

<div id="controlPanel" style="display:none;">
  <h2>Painel de Controle - Reservas e Pagamentos</h2>
  <table>
    <thead>
      <tr>
        <th>Número</th><th>E-mail</th><th>Telefone</th><th>Status</th><th>Código</th><th>Confirmar Pagamento</th>
      </tr>
    </thead>
    <tbody id="controlTable">
      <!-- reservas dinâmicas -->
    </tbody>
  </table>
</div>

<div id="grid">
  <!-- números da rifa aparecerão aqui -->
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDocs, collection, updateDoc } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDPbVECM-nqIMhDbiYA1cnnApwpNONVamg",
    authDomain: "ftc-premios.firebaseapp.com",
    projectId: "ftc-premios",
    storageBucket: "ftc-premios.appspot.com",
    messagingSenderId: "366955454287",
    appId: "1:366955454287:web:dd871826b8fae839706f3a",
    measurementId: "G-3M7WJKPMPM"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let raffleData = {
    number: '001',
    value: 10.00,
    date: '',
    time: '',
  };
  const reservedNumbers = {}; // Reserva local espelho

  const loginSection = document.getElementById('loginSection');
  const adminPanel = document.getElementById('adminPanel');
  const controlPanel = document.getElementById('controlPanel');

  const grid = document.getElementById('grid');

  // Renderiza a grade de números 00-99
  function renderGrid() {
    grid.innerHTML = '';
    for(let i=0; i<100; i++) {
      const numStr = i.toString().padStart(2,'0');
      const div = document.createElement('div');
      div.className = 'num';
      div.textContent = numStr;
      if(reservedNumbers[numStr]) {
        div.classList.add(reservedNumbers[numStr].pago ? 'paid' : 'reserved');
        div.title = reservedNumbers[numStr].pago ? 'Pago' : 'Reservado';
      } else {
        div.title = 'Disponível';
        div.classList.add('num');
      }
      grid.appendChild(div);
    }
  }

  // Carrega reservas do Firestore
  async function carregarReservas() {
    const snapshot = await getDocs(collection(db, "reservas"));
    snapshot.forEach(doc => {
      reservedNumbers[doc.id] = doc.data();
    });
    renderGrid();
    renderControlTable();
  }

  // Renderiza painel de controle
  function renderControlTable(){
    const tbody = document.getElementById('controlTable');
    tbody.innerHTML = '';
    Object.entries(reservedNumbers).forEach(([num, data])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${num}</td><td>${data.email}</td><td>${data.telefone}</td><td>${data.pago ? 'Pago' : 'Reservado'}</td><td>${data.codigo}</td>
        <td><button ${data.pago ? 'disabled' : ''} onclick="confirmarPagamento('${num}')">Confirmar Pagamento</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Salva uma reserva nova
  async function salvarReserva(num, email, telefone, codigo) {
    await setDoc(doc(db, "reservas", num), {
      email,
      telefone,
      codigo,
      pago: false
    });
    reservedNumbers[num] = { email, telefone, codigo, pago: false };
    renderGrid();
    renderControlTable();
  }

  // Confirma pagamento no Firestore
  async function confirmarPagamento(num) {
    const ref = doc(db, "reservas", num);
    await updateDoc(ref, { pago: true });
    reservedNumbers[num].pago = true;
    renderGrid();
    renderControlTable();
  }
  window.confirmarPagamento = confirmarPagamento; // tornar global para botão onclick

  // Autenticação Firebase - login admin
  async function login(){
    const email = document.getElementById('emailInput').value;
    const senha = document.getElementById('passwordInput').value;
    try {
      await signInWithEmailAndPassword(auth, email, senha);
      document.getElementById('loginMsg').textContent = '';
      loginSection.style.display = 'none';
      adminPanel.style.display = 'block';
      controlPanel.style.display = 'block';
      carregarReservas();
    } catch (e) {
      document.getElementById('loginMsg').textContent = 'Erro ao fazer login: ' + e.message;
    }
  }
  window.login = login;

  // Logout admin
  async function logout() {
    await signOut(auth);
    loginSection.style.display = 'block';
    adminPanel.style.display = 'none';
    controlPanel.style.display = 'none';
    document.getElementById('emailInput').value = '';
    document.getElementById('passwordInput').value = '';
  }
  window.logout = logout;

  // Observe estado da autenticação para manter sessão
  onAuthStateChanged(auth, user => {
    if(user) {
      loginSection.style.display = 'none';
      adminPanel.style.display = 'block';
      controlPanel.style.display = 'block';
      carregarReservas();
    } else {
      loginSection.style.display = 'block';
      adminPanel.style.display = 'none';
      controlPanel.style.display = 'none';
    }
  });

  // Salva informações da rifa - você pode salvar no Firestore se quiser persistir
  function saveRaffleInfo(){
    raffleData.number = document.getElementById('raffleNumber').value;
    raffleData.value = parseFloat(document.getElementById('raffleValue').value);
    raffleData.date = document.getElementById('raffleDate').value;
    raffleData.time = document.getElementById('raffleTime').value;
    alert('Dados da rifa salvos localmente.');
  }
  window.saveRaffleInfo = saveRaffleInfo;

  // Iniciar a grade inicialmente vazia
  renderGrid();
</script>

</body>
</html>
