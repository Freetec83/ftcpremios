<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Rifa Online</title>
<style>
  table { border-collapse: collapse; width: 100%; max-width: 600px; margin-top: 20px; }
  th, td { border: 1px solid #999; padding: 8px; text-align: center; }
  .Disponível { background-color: #e0ffe0; }
  .Reservado { background-color: #fff3cd; }
  .Pago { background-color: #c3e6cb; }
  button { padding: 6px 12px; margin: 5px; cursor: pointer; }
  #qrcode { margin-top: 20px; }
</style>
</head>
<body>

<h1>Rifa Online</h1>

<table id="tabelaRifa">
  <thead>
    <tr><th>Número</th><th>Status</th><th>Nome</th><th>Ação</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="formReserva" style="display:none; margin-top:20px;">
  <h2>Reservar Número: <span id="numeroSelecionado"></span></h2>
  <label>Nome:</label><br /><input type="text" id="nome" /><br />
  <label>Email:</label><br /><input type="email" id="email" /><br />
  <label>Telefone:</label><br /><input type="text" id="telefone" /><br />
  <button id="btnReservar">Reservar e Gerar PIX</button>
</div>

<div id="qrcode"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  const webAppUrl = 'https://script.google.com/macros/s/AKfycbwvEdBpramO2rpEDttU55DxDf2eFTvYA3jkXk-METyH9tLFX_T94xlvMVtDPsV74s-g/exec';
  let numeroSelecionado = null;
  const tabelaBody = document.querySelector("#tabelaRifa tbody");
  const formReserva = document.getElementById("formReserva");
  const numeroSpan = document.getElementById("numeroSelecionado");
  const btnReservar = document.getElementById("btnReservar");
  const qrcodeDiv = document.getElementById("qrcode");

  function atualizarTabela() {
    fetch(webAppUrl, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({action: "listar"})
    })
    .then(res => res.json())
    .then(data => {
      tabelaBody.innerHTML = "";
      data.forEach(item => {
        const tr = document.createElement("tr");
        tr.className = item.status;
        tr.innerHTML = `
          <td>${item.numero}</td>
          <td>${item.status}</td>
          <td>${item.nome || ""}</td>
          <td>${item.status === "Disponível" ? `<button onclick="mostrarFormulario('${item.numero}')">Reservar</button>` : ""}</td>
        `;
        tabelaBody.appendChild(tr);
      });
    });
  }

  function mostrarFormulario(numero) {
    numeroSelecionado = numero;
    numeroSpan.textContent = numero;
    formReserva.style.display = "block";
    qrcodeDiv.innerHTML = "";
    document.getElementById("nome").value = "";
    document.getElementById("email").value = "";
    document.getElementById("telefone").value = "";
  }

  btnReservar.onclick = () => {
    const nome = document.getElementById("nome").value.trim();
    const email = document.getElementById("email").value.trim();
    const telefone = document.getElementById("telefone").value.trim();

    if(!nome || !email || !telefone) {
      alert("Por favor, preencha todos os campos.");
      return;
    }

    fetch(webAppUrl, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        action: "reservar",
        numero: numeroSelecionado,
        nome,
        email,
        telefone
      })
    })
    .then(res => res.json())
    .then(res => {
      if(res.error) {
        alert(res.error);
        formReserva.style.display = "none";
      } else {
        alert(res.message);
        gerarQRCodePIX(res.codigoVenda);
        formReserva.style.display = "none";
        atualizarTabela();
      }
    });
  };

  function gerarQRCodePIX(codigoVenda) {
    const chavePIX = "SEU-PIX-CHAVE";
    const valor = "10.00";
    const descricao = `Rifa - ${codigoVenda}`;
    const payload = `00020126580014BR.GOV.BCB.PIX0136${chavePIX}520400005303986540${valor.replace(".", "")}5802BR5925SeuNome6009SuaCidade6304XXXX`;
    qrcodeDiv.innerHTML = "";
    new QRCode(qrcodeDiv, {
      text: payload,
      width: 256,
      height: 256,
      colorDark : "#000000",
      colorLight : "#ffffff"
    });
  }

  atualizarTabela();
</script>

</body>
</html>
