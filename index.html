<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTC Prêmios - Rifa Online</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 10px;}
  .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.2);}
  h1 { text-align: center; margin-bottom: 10px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 16px; text-align: center; }
  table td { padding: 12px 0; border: 1px solid #ccc; cursor: pointer; font-size: 0.9rem; border-radius: 4px; }
  td.available { background-color: #ccc; color: #000; }
  td.reserved { background-color: #80c0ff; color: #000; cursor: default; }
  td.paid { background-color: #0059b3; color: #fff; cursor: default; }
  #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
  .modal-content { background:white; padding:20px; border-radius:8px; width:90%; max-width:400px; }
  .modal-content input { width:100%; padding:6px; margin-bottom:10px; font-size:1rem; }
  .buttons { display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
  button { padding:8px 15px; font-size:1rem; border:none; border-radius:5px; cursor:pointer; }
  button.primary { background:#007bff; color:#fff; }
  button.secondary { background:#bbb; color:#000; }
  #stats { margin-bottom: 10px; font-weight:bold; text-align:center; }
  #drawSection { text-align:center; margin-top:16px; }
  #drawNumber { font-size:50px; font-weight:bold; margin-top:10px; }
  #controlButtons { text-align:center; margin-bottom:10px; }
  footer { text-align:center; margin-top:20px; font-style:italic; color:#555; }
</style>
</head>
<body>

<div class="container">
  <h1>FTC Prêmios - Rifa Online</h1>
  <div id="stats">Números pagos: 0 | Arrecadação: R$0</div>

  <div id="controlButtons">
    <button id="resetRifaBtn" class="secondary">Resetar Rifa</button>
    <button id="newRifaBtn" class="primary">Nova Rifa</button>
  </div>

  <table id="numbersTable" aria-label="Tabela de números da rifa"></table>

  <div id="drawSection">
    <button id="startDraw" class="primary">Sortear Número (organizador)</button>
    <div id="drawNumber">--</div>
    <div id="winnerInfo"></div>
    <button id="downloadPDF" class="secondary" style="margin-top:10px;">Download PDF do Sorteio</button>
  </div>
</div>

<!-- Modal de Reserva -->
<div id="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <h3>Reservar Número <span id="selectedNumber"></span></h3>
    <input type="text" id="nameInput" placeholder="Nome" required>
    <input type="email" id="emailInput" placeholder="Email" required>
    <input type="text" id="phoneInput" placeholder="Telefone" required>
    <div class="buttons">
      <button class="primary" id="confirmReserve">Confirmar</button>
      <button class="secondary" id="cancelReserve">Cancelar</button>
      <button class="secondary" id="cancelTicketBtn">Cancelar Reserva</button>
    </div>
  </div>
</div>

<footer>© FTC Prêmios</footer>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase CDN -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDPbVECM-nqIMhDbiYA1cnnApwpNONVamg",
    authDomain: "ftc-premios.firebaseapp.com",
    projectId: "ftc-premios",
    storageBucket: "ftc-premios.firebasestorage.app",
    messagingSenderId: "366955454287",
    appId: "1:366955454287:web:dd871826b8fae839706f3a",
    measurementId: "G-3M7WJKPMPM"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ticketPrice = 10;
  const maxNumber = 99;
  const organizerWhatsAppNumber = "5511999999999"; 
  const panelPassword = "8378";

  let tickets = [];
  let selectedNumber = null;
  let lastWinner = null;

  const numbersTable = document.getElementById('numbersTable');
  const stats = document.getElementById('stats');
  const modal = document.getElementById('modal');
  const nameInput = document.getElementById('nameInput');
  const emailInput = document.getElementById('emailInput');
  const phoneInput = document.getElementById('phoneInput');
  const selectedNumberEl = document.getElementById('selectedNumber');
  const confirmReserveBtn = document.getElementById('confirmReserve');
  const cancelReserveBtn = document.getElementById('cancelReserve');
  const cancelTicketBtn = document.getElementById('cancelTicketBtn');
  const drawNumberEl = document.getElementById('drawNumber');
  const winnerInfo = document.getElementById('winnerInfo');
  const downloadPDFBtn = document.getElementById('downloadPDF');
  const resetRifaBtn = document.getElementById('resetRifaBtn');
  const newRifaBtn = document.getElementById('newRifaBtn');

  function updateStats() {
    const paidCount = tickets.filter(t=>t.status==='paid').length;
    stats.textContent = `Números pagos: ${paidCount} | Arrecadação: R$${paidCount*ticketPrice}`;
  }

  function renderTable() {
    numbersTable.innerHTML='';
    for(let i=0;i<=maxNumber;i++){
      const t = tickets[i] || {number:i.toString().padStart(2,'0'), status:'available'};
      const td = document.createElement('td');
      td.textContent=t.number;
      td.className=t.status;
      if(t.status==='available') td.onclick=()=>openModal(t.number);
      if(i%10===0){ const tr=document.createElement('tr'); numbersTable.appendChild(tr); tr.appendChild(td);}
      else numbersTable.lastChild.appendChild(td);
    }
    updateStats();
  }

  function openModal(number){
    selectedNumber=number;
    selectedNumberEl.textContent=number;
    modal.style.display='flex';
    nameInput.value=''; emailInput.value=''; phoneInput.value='';
    nameInput.focus();
  }

  function closeModal(){ modal.style.display='none'; }

  async function confirmReserve(){
    const name=nameInput.value.trim();
    const email=emailInput.value.trim();
    const phone=phoneInput.value.trim();
    if(!name||!email||!phone){ alert('Preencha todos os campos'); return; }

    const docRef = doc(db,'tickets',selectedNumber);
    const code='RES-'+selectedNumber+'-'+Math.floor(1000+Math.random()*9000);
    await setDoc(docRef,{number:selectedNumber,status:'reserved',name,email,phone,code},{merge:true});
    closeModal();
    const waMessage = encodeURIComponent(`Número ${selectedNumber} reservado.\nNome:${name}\nEmail:${email}\nTelefone:${phone}\nCódigo:${code}`);
    window.open(`https://wa.me/${organizerWhatsAppNumber}?text=${waMessage}`,'_blank');
  }

  confirmReserveBtn.onclick=confirmReserve;
  cancelReserveBtn.onclick=closeModal;

  cancelTicketBtn.onclick=async()=>{
    const pass=prompt('Senha do organizador:');
    if(pass!==panelPassword){ alert('Senha incorreta'); return; }
    const docRef = doc(db,'tickets',selectedNumber);
    await setDoc(docRef,{status:'available',name:'',email:'',phone:'',code:''},{merge:true});
    closeModal();
  }

  const ticketsCol = collection(db,'tickets');
  onSnapshot(ticketsCol,(snapshot)=>{
    tickets=[];
    snapshot.forEach(docSnap=>{tickets.push(docSnap.data());});
    for(let i=0;i<=maxNumber;i++){
      if(!tickets.find(t=>t.number===i.toString().padStart(2,'0'))){
        tickets.push({
