<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Rifa Dinâmica com Google Sheets</title>
<style>
  body { font-family: Arial, sans-serif; padding: 15px; }
  table { border-collapse: collapse; width: 100%; max-width: 700px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  tr.disponivel { background-color: #dff0d8; cursor: pointer; }
  tr.reservado { background-color: #fcf8e3; }
  tr.pago { background-color: #d9edf7; }
  tr.selecionado { outline: 3px solid green; }
  .mensagem { margin-top: 10px; font-weight: bold; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
</style>
</head>
<body>

<h1>Rifa Online</h1>

<table id="tabelaNumeros" aria-label="Tabela de Números">
  <thead>
    <tr><th>Número</th><th>Status</th><th>Nome</th><th>Email</th><th>Telefone</th></tr>
  </thead>
  <tbody></tbody>
</table>

<section>
  <h2>Reservar Número</h2>
  <form id="formReserva">
    <label>Número selecionado: <span id="numeroSelecionado">Nenhum</span></label><br />
    <input type="text" id="nome" placeholder="Seu nome" required /><br />
    <input type="email" id="email" placeholder="Seu email" required /><br />
    <input type="tel" id="telefone" placeholder="Seu telefone" required /><br />
    <button type="submit" id="btnReservar" disabled>Reservar</button>
  </form>
  <div class="mensagem" id="mensagemReserva"></div>
</section>

<hr/>

<section>
  <h2>Sorteio</h2>
  <button id="btnSortear" disabled>Sortear Número Pago</button>
  <div class="mensagem" id="resultadoSorteio"></div>
</section>

<hr/>

<section>
  <h2>Painel do Organizador</h2>
  <input type="password" id="senhaOrganizador" placeholder="Senha" />
  <button id="btnLogin">Entrar</button>
  <div id="painelOrganizador" style="display:none; margin-top:15px;">
    <h3>Reservas Pendentes</h3>
    <table id="tabelaReservas" style="width:100%;">
      <thead><tr><th>Número</th><th>Nome</th><th>Email</th><th>Telefone</th><th>Ação</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="btnResetar">Resetar Rifa</button>
  </div>
  <div class="mensagem" id="mensagemPainel"></div>
</section>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxwLJxXi8Sg9SIaDWUKCmJ9YM50DK_r9UafiuB7ZCoszGlNtyjxtSxSV9V360bIK3l9/exec';

let numeros = [];
let reservas = {};
let pagos = {};
let numeroSelecionado = null;
const senhaOrganizadorCorreta = '8378';

const tabelaNumeros tbody = document.querySelector('#tabelaNumeros tbody');
const tabelaReservas tbody = document.querySelector('#tabelaReservas tbody');
const numeroSelecionadoSpan = document.getElementById('numeroSelecionado');
const btnReservar = document.getElementById('btnReservar');
const btnSortear = document.getElementById('btnSortear');
const mensagemReserva = document.getElementById('mensagemReserva');
const resultadoSorteio = document.getElementById('resultadoSorteio');
const senhaOrganizador = document.getElementById('senhaOrganizador');
const btnLogin = document.getElementById('btnLogin');
const painelOrganizador = document.getElementById('painelOrganizador');
const btnResetar = document.getElementById('btnResetar');
const mensagemPainel = document.getElementById('mensagemPainel');

function atualizaInterface() {
  tabelaNumeros tbody.innerHTML = '';
  numeros.forEach(item => {
    const tr = document.createElement('tr');
    tr.dataset.numero = item.numero;
    tr.className = 'disponivel';
    if (pagos[item.numero]) {
      tr.className = 'pago';
    } else if (reservas[item.numero]) {
      tr.className = 'reservado';
    }
    tr.innerHTML = `
      <td>${item.numero}</td>
      <td>${item.status||'Disponível'}</td>
      <td>${item.nome||''}</td>
      <td>${item.email||''}</td>
      <td>${item.telefone||''}</td>
    `;
    if(tr.className === 'disponivel'){
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', () => selecionarNumero(item.numero));
    }
    tabelaNumeros tbody.appendChild(tr);
  });
  atualizaPainelOrganizador();
  btnSortear.disabled = Object.keys(pagos).length === 0;
  btnReservar.disabled = numeroSelecionado === null;
}

function preencherReservasEpagos() {
  reservas = {};
  pagos = {};
  numeros.forEach(item => {
    if(item.status === 'reservado') reservas[item.numero] = item;
    else if(item.status === 'pago') pagos[item.numero] = item;
  });
}

function selecionarNumero(numero) {
  numeroSelecionado = numero;
  numeroSelecionadoSpan.textContent = numero;
  btnReservar.disabled = false;
  mensagemReserva.textContent = '';
}

async function carregarDados() {
  try {
    const response = await fetch(WEB_APP_URL);
    const data = await response.json();
    numeros = data;
    preencherReservasEpagos();
    atualizaInterface();
  } catch (e) {
    mensagemReserva.textContent = 'Erro ao carregar dados: ' + e.message;
  }
}

async function reservarNumero(e) {
  e.preventDefault();
  const nome = document.getElementById('nome').value.trim();
  const email = document.getElementById('email').value.trim();
  const telefone = document.getElementById('telefone').value.trim();

  if (!numeroSelecionado) {
    mensagemReserva.textContent = 'Selecione um número.';
    return;
  }
  if (!nome || !email || !telefone) {
    mensagemReserva.textContent = 'Preencha todos os campos.';
    return;
  }

  const dadosReserva = {
    numero: numeroSelecionado,
    status: 'reservado',
    nome,
    email,
    telefone,
    codigoVenda: 'RIF-' + numeroSelecionado + '-' + Date.now().toString(36).toUpperCase(),
    timestamp: Date.now()
  };

  try {
    const response = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(dadosReserva)
    });
    const resp = await response.json();
    if (resp.result === 'success') {
      mensagemReserva.textContent = 'Número reservado com sucesso! Aguarde pagamento.';
      numeroSelecionado = null;
      numeroSelecionadoSpan.textContent = 'Nenhum';
      btnReservar.disabled = true;
      document.getElementById('formReserva').reset();
      await carregarDados();
    } else {
      mensagemReserva.textContent = 'Erro ao reservar o número.';
    }
  } catch (e) {
    mensagemReserva.textContent = 'Erro na comunicação com o servidor.';
  }
}

async function confirmarPagamento(numero) {
  if (!painelOrganizador.style.display) {
    alert('Acesso negado.');
    return;
  }
  const reserva = reservas[numero];
  if (!reserva) return;

  const pagamento = {...reserva, status: 'pago'};
  try {
    const response = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(pagamento)
    });
    const resp = await response.json();
    if (resp.result === 'success'){
      alert(`Pagamento confirmado para o número ${numero}`);
      await carregarDados();
    } else {
      alert('Erro ao confirmar pagamento.');
    }
  } catch(e) {
    alert('Erro de comunicação');
  }
}

function atualizaPainelOrganizador() {
  tabelaReservas tbody.innerHTML = '';
  for(const num in reservas) {
    const r = reservas[num];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${num}</td><td>${r.nome}</td><td>${r.email}</td><td>${r.telefone}</td>
      <td><button onclick="confirmarPagamento('${num}')">Confirmar pagamento</button></td>`;
    tabelaReservas tbody.appendChild(tr);
  }
}

btnLogin.onclick = () => {
  if(senhaOrganizador.value === senhaOrganizadorCorreta) {
    painelOrganizador.style.display = 'block';
    senhaOrganizador.value = '';
    mensagemPainel.textContent = '';
  } else {
    mensagemPainel.textContent = 'Senha incorreta';
  }
};

btnSortear.onclick = () => {
  if(painelOrganizador.style.display === 'none') {
    alert('Acesso negado.');
    return;
  }
  const chavesPagos = Object.keys(pagos);
  if(chavesPagos.length === 0) {
    resultadoSorteio.textContent = 'Nenhum número pago para sortear.';
    return;
  }
  const sorteado = chavesPagos[Math.floor(Math.random()*chavesPagos.length)];
  resultadoSorteio.textContent = `Número sorteado: ${sorteado}`;
};

btnResetar.onclick = async () => {
  if(painelOrganizador.style.display === 'none') {
    alert('Acesso negado.');
    return;
  }
  if(!confirm('Confirma resetar a rifa?')) return;
  const promessas = [];
  [...Object.values(reservas), ...Object.values(pagos)].forEach(item => {
    const resetData = {...item, status: '', nome: '', email: '', telefone: '', codigoVenda: '', timestamp: ''};
    promessas.push(fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(resetData)
    }));
  });
  await Promise.all(promessas);
  resultadoSorteio.textContent = '';
  await carregarDados();
  alert('Rifa resetada.');
};

document.getElementById('formReserva').addEventListener('submit', reservarNumero);

carregarDados();
</script>

</body>
</html>
