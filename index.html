<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rifa N¬∫001 - FTC Pr√™mios (Privada)</title>
<style>
:root{--accent:#0b74da;--paid:#5cb85c;--reserved:#f0ad4e;--bg:#f7f7f7}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#222;padding:16px}
.container{max-width:1100px;margin:0 auto}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo{height:56px}
h1{margin:0;font-size:20px}
.sub{color:#555;font-size:14px}
.topright{margin-left:auto;text-align:right}
.grid{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin:18px 0}
.num{background:#fff;padding:10px;border-radius:8px;text-align:center;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.06);font-weight:700}
.num.reserved{background:linear-gradient(90deg,#fff3e0,#fff7ed);color:#8a4b00;cursor:not-allowed}
.num.paid{background:linear-gradient(90deg,#e8f7ea,#f3fff5);color:#1b5e20;cursor:not-allowed}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
button{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
button.secondary{background:#ddd;color:#222}
.card{background:#fff;padding:12px;border-radius:8px;margin-top:8px}
.small{font-size:13px;color:#555}
.stats{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.stat{background:#fff;padding:10px;border-radius:8px}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5)}
input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
.roleta-wrap{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.roleta{width:320px;height:120px;background:#111;border-radius:12px;color:#fff;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:800;box-shadow:0 6px 20px rgba(0,0,0,0.2)}
.footer{margin-top:14px;text-align:center;color:#666;font-size:13px}
.mute{background:#fff;padding:6px;border-radius:6px;border:1px solid #ddd;cursor:pointer}
@media(max-width:720px){.grid{grid-template-columns:repeat(5,1fr)}header{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="container">
  <header>
    <img src="logo.png" alt="FTC Pr√™mios" class="logo" onerror="this.style.display='none'">
    <div>
      <h1>Rifa N¬∫001 ‚Äì FTC Pr√™mios</h1>
      <div class="sub">Valor por n√∫mero: <strong>R$10,00</strong> ‚Ä¢ Pr√™mio: <strong>40% do total arrecadado</strong></div>
    </div>
    <div class="topright">
      <div class="small">Privado ‚Ä¢ Apenas convidados</div>
    </div>
  </header>

  <div class="actions">
    <button onclick="showReg()">üìú Regulamento</button>
    <button class="secondary" onclick="openAdmin()">üîê Organizador</button>
    <button class="secondary" onclick="exportCSV()">‚§ì Exportar CSV</button>
    <button onclick="window.open('https://chat.whatsapp.com/ERUihUvpLiN3HrDQy4LALO?mode=wwt','_blank')">üîó Entrar no grupo da rifa</button>
    <button onclick="openRoletaPanel()">üé≤ Sortear (painel)</button>
  </div>

  <div class="card stats">
    <div class="stat"><strong id="countReserved">0</strong> reservados</div>
    <div class="stat"><strong id="countPaid">0</strong> pagos</div>
    <div class="stat"><strong id="totalArrecadado">R$0,00</strong> arrecadado</div>
    <div class="stat"><strong id="prizeAmount">R$0,00</strong> (40%)</div>
    <div class="stat" id="countdownArea">Sorteio: <span id="drawDateText">--/--/----</span></div>
  </div>

  <div class="card small" style="margin-top:12px;text-align:center;color:#555;font-size:13px">
    Importante: pagamentos devem ser feitos no grupo privado via PIX (ou acordo entre participantes). O organizador confirma pagamento manualmente.
  </div>

  <div class="grid" id="grid"></div>

  <div class="card" id="salesBox">
    <strong>Vendas / Reservas</strong>
    <div id="salesList" style="margin-top:10px">Nenhuma venda ainda.</div>
  </div>

  <div style="margin-top:12px" class="footer">
    <div>üîí Esta rifa √© de car√°ter <strong>privado</strong> e restrita a participantes convidados. Ao participar, voc√™ aceita o regulamento.</div>
  </div>
</div>

<!-- Modal: reserve -->
<div id="modalReserve" class="modal" style="display:none">
  <div class="card" style="max-width:520px;width:94%">
    <h3>Reservar n√∫mero <span id="modalNum"></span></h3>
    <label>Nome</label>
    <input id="resName" placeholder="Seu nome">
    <label>Celular (com DDD, s√≥ n√∫meros)</label>
    <input id="resPhone" placeholder="21999998888">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="confirmReserve()">Reservar</button>
      <button class="secondary" onclick="closeReserve()">Cancelar</button>
    </div>
    <div id="afterReserve" style="display:none;margin-top:12px">
      <div class="small">Depois de reservado, envie no grupo o comprovante do pagamento ao organizador. Ele confirmar√° e marcar√° como Pago.</div>
      <div style="margin-top:8px"><button onclick="window.open('https://chat.whatsapp.com/ERUihUvpLiN3HrDQy4LALO?mode=wwt','_blank')">Entrar no grupo</button></div>
    </div>
  </div>
</div>

<!-- Modal: regulamento -->
<div id="modalReg" class="modal" style="display:none">
  <div class="card" style="max-width:720px;width:94%">
    <h3>Regulamento (resumido)</h3>
    <p class="small">
      Rifa N¬∫001 ‚Äî FTC Pr√™mios<br>
      ‚Ä¢ N√∫meros: 00‚Äì99 ‚Ä¢ Valor: R$10,00 por n√∫mero.<br>
      ‚Ä¢ Pr√™mio: 40% do total arrecadado. <br>
      ‚Ä¢ Pagamento: via acordo no grupo privado (PIX). O organizador confirma manualmente ap√≥s ver comprovante. <br>
      ‚Ä¢ Sorteio: p√∫blico, realizado pelo organizador no site; ser√° gravado. <br>
      Ao participar, o usu√°rio declara aceitar o regulamento.
    </p>
    <div style="text-align:right;margin-top:8px"><button onclick="closeReg()">Fechar</button></div>
  </div>
</div>

<!-- Modal: admin -->
<div id="modalAdmin" class="modal" style="display:none">
  <div class="card" style="max-width:900px;width:96%">
    <h3>Painel do Organizador</h3>
    <div class="small">Senha: <strong>8378</strong></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="fetchSheetBackup()">üîÑ Atualizar (backup)</button>
      <button onclick="markAllPaid()">‚úîÔ∏è Marcar todos como pagos</button>
      <button class="secondary" onclick="clearAll()">üóëÔ∏è Limpar tudo (apagar local)</button>
      <button onclick="closeAdmin()">Fechar</button>
    </div>

    <div style="margin-top:10px">
      <label>Data/Hora do sorteio (mostrar para participantes)</label>
      <input id="drawDateInput" placeholder="DD/MM/YYYY HH:MM">
      <div style="margin-top:8px">
        <button onclick="saveDrawDate()">Salvar data do sorteio</button>
        <button class="secondary" onclick="clearDrawDate()">Limpar data</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <strong>Reservas / Vendas (local)</strong>
      <div id="adminSales" style="margin-top:8px"></div>
    </div>

    <div style="margin-top:12px">
      <strong>Sorteio (roleta s√≥ entre pagos)</strong>
      <div class="roleta-wrap" style="margin-top:8px">
        <div class="roleta" id="roletaBox">--</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button onclick="startRoleta()">Iniciar roleta (cassino)</button>
          <button class="secondary" onclick="stopSound()">Parar som</button>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="pingSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="spinSound" src="https://actions.google.com/sounds/v1/foley/slot_machine_spin.ogg"></audio>
<audio id="stopSound" src="https://actions.google.com/sounds/v1/drums/crash.ogg"></audio>

<script>
/* CONFIG */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw2rWmBMR0LTZZCmxozw4Rji9PHfL-RA-Plor0a6g8Xf5njs8WWkqQiqHsRhG8pAmJM/exec';
const ADMIN_PASS = '8378';
const PRIZE_PERCENT = 0.40;
const GROUP_LINK = 'https://chat.whatsapp.com/ERUihUvpLiN3HrDQy4LALO?mode=wwt';
/* END CONFIG */

const salesKey = 'rifa_00_99_sales_v2';
let sales = JSON.parse(localStorage.getItem(salesKey) || '[]');
let mute = false;
let roletaTimer = null;

/* Render */
function renderGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  for(let i=0;i<100;i++){
    const n = String(i).padStart(2,'0');
    const el = document.createElement('div');
    el.className = 'num';
    el.dataset.num = n;
    const s = sales.find(x=>x.number===n);
    if(s){
      el.textContent = n + (s.paid ? ' ‚Ä¢ PAGO' : ' ‚Ä¢ RESERVADO');
      el.classList.add(s.paid? 'paid' : 'reserved');
    } else {
      el.textContent = n;
      el.onclick = ()=> openReserve(n);
    }
    grid.appendChild(el);
  }
  renderSales();
  updateStats();
}

function openReserve(n){
  document.getElementById('modalReserve').style.display='flex';
  document.getElementById('modalNum').textContent = n;
  document.getElementById('afterReserve').style.display = 'none';
}
function closeReserve(){ document.getElementById('modalReserve').style.display='none'; }

function confirmReserve(){
  const n = document.getElementById('modalNum').textContent;
  const name = document.getElementById('resName').value.trim();
  const phone = document.getElementById('resPhone').value.trim();
  if(!name || !phone) return alert('Preencha nome e celular.');
  const now = new Date().toISOString();
  const item = { number: n, name, phone, date: now, paid: false };
  sales.push(item);
  localStorage.setItem(salesKey, JSON.stringify(sales));
  // send backup to Web App
  sendToWebApp(item);
  renderGrid();
  document.getElementById('afterReserve').style.display='block';
  playPing();
}

function renderSales(){
  const box = document.getElementById('salesList');
  if(sales.length===0){ box.innerHTML='Nenhuma venda ainda.'; return; }
  let html = '<table><thead><tr><th>N¬∫</th><th>Nome</th><th>Celular</th><th>Pago?</th></tr></thead><tbody>';
  sales.slice().reverse().forEach(s=>{
    html += `<tr><td>${s.number}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.phone)}</td><td>${s.paid? 'SIM' : 'N√ÉO'}</td></tr>`;
  });
  html += '</tbody></table>';
  box.innerHTML = html;
}

function updateStats(){
  const reserved = sales.length;
  const paid = sales.filter(s=>s.paid).length;
  const total = paid * 10;
  const prize = total * PRIZE_PERCENT;
  document.getElementById('countReserved').textContent = reserved;
  document.getElementById('countPaid').textContent = paid;
  document.getElementById('totalArrecadado').textContent = formatMoney(total);
  document.getElementById('prizeAmount').textContent = formatMoney(prize);
}

/* Admin */
function openAdmin(){
  const pass = prompt('Senha do organizador:');
  if(pass !== ADMIN_PASS) return alert('Senha incorreta.');
  document.getElementById('modalAdmin').style.display='flex';
  renderAdminSales();
  loadDrawDateToInput();
}

function closeAdmin(){ document.getElementById('modalAdmin').style.display='none'; }

function renderAdminSales(){
  const box = document.getElementById('adminSales');
  if(sales.length===0){ box.innerHTML='Nenhuma venda.'; return; }
  let html = '<table><thead><tr><th>N¬∫</th><th>Nome</th><th>Celular</th><th>Pago</th><th>A√ß√µes</th></tr></thead><tbody>';
  sales.forEach((s,idx)=>{
    html += `<tr><td>${s.number}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.phone)}</td><td>${s.paid? 'SIM' : 'N√ÉO'}</td><td>`+
            `<button onclick="confirmPaid(${idx})">Confirmar Pago</button> <button class="secondary" onclick="cancelSale(${idx})">Cancelar</button></td></tr>`;
  });
  html += '</tbody></table>';
  box.innerHTML = html;
}

function confirmPaid(idx){
  sales[idx].paid = true;
  localStorage.setItem(salesKey, JSON.stringify(sales));
  // send update to Web App
  sendToWebApp(Object.assign({}, sales[idx], { status: 'Pago' }));
  renderGrid(); renderAdminSales();
}

function cancelSale(idx){
  if(!confirm('Remover essa reserva?')) return;
  sales.splice(idx,1);
  localStorage.setItem(salesKey, JSON.stringify(sales));
  renderGrid(); renderAdminSales();
}

function markAllPaid(){
  if(!confirm('Marcar todas as reservas como pagas?')) return;
  sales.forEach(s=>s.paid=true);
  localStorage.setItem(salesKey, JSON.stringify(sales));
  sales.forEach(s=> sendToWebApp(Object.assign({}, s, { status: 'Pago' })));
  renderGrid(); renderAdminSales();
}

function clearAll(){
  if(!confirm('Apagar todas as vendas e reservas locais?')) return;
  sales = []; localStorage.removeItem(salesKey);
  renderGrid(); renderAdminSales();
}

/* Draw date */
function saveDrawDate(){
  const v = document.getElementById('drawDateInput').value.trim();
  if(!v) return alert('Digite data/hora no formato DD/MM/YYYY HH:MM');
  localStorage.setItem('rifa_draw_date', v);
  loadDrawDateToDisplay();
  alert('Data salva.');
}
function clearDrawDate(){ localStorage.removeItem('rifa_draw_date'); loadDrawDateToDisplay(); alert('Data limpa.'); }
function loadDrawDateToInput(){
  document.getElementById('drawDateInput').value = localStorage.getItem('rifa_draw_date') || '';
}
function loadDrawDateToDisplay(){
  const v = localStorage.getItem('rifa_draw_date');
  document.getElementById('drawDateText').textContent = v || '--/--/---- --:--';
}
loadDrawDateToDisplay();

/* Roleta (cassino style) */
function openRoletaPanel(){ openAdmin(); }
function startRoleta(){
  const pool = sales.filter(s=>s.paid).map(s=>s.number);
  if(pool.length===0) return alert('Sem n√∫meros pagos para sortear.');
  // play spin sound and animate random numbers then pick winner
  const box = document.getElementById('roletaBox');
  let steps = 40 + Math.floor(Math.random()*40);
  let i = 0;
  playSpin();
  roletaTimer = setInterval(()=>{
    const pick = pool[Math.floor(Math.random()*pool.length)];
    box.textContent = pick;
    i++;
    if(i>=steps){ clearInterval(roletaTimer); stopSpin(); finalizeWinner(pick); }
  }, 80);
}

function playPing(){ if(mute) return; document.getElementById('pingSound').play().catch(()=>{}); }
function playSpin(){ if(mute) return; document.getElementById('spinSound').loop = true; document.getElementById('spinSound').play().catch(()=>{}); }
function stopSpin(){ document.getElementById('spinSound').pause(); document.getElementById('spinSound').currentTime = 0; if(!mute) document.getElementById('stopSound').play().catch(()=>{}); }
function stopSound(){ mute = true; document.getElementById('spinSound').pause(); }

/* finalize winner: display, mark in local sheet and send backup */
function finalizeWinner(number){
  const winner = sales.find(s=>s.number===number);
  const now = new Date().toISOString();
  const displayText = `üéâ Vencedor: ${number} ‚Äî ${winner ? winner.name + ' ('+maskPhone(winner.phone)+')' : 'Dados n√£o encontrados' }`;
  alert(displayText + '\n\nO resultado ser√° gravado localmente e enviado em backup.');
  // write result locally (add fields)
  localStorage.setItem('rifa_last_winner', JSON.stringify({ number, winner: winner||null, date: now }));
  // send to Web App as a result record
  const resultRecord = { number, name: winner ? winner.name : '', phone: winner ? winner.phone : '', status: 'Vencedor', date: now };
  sendToWebApp(resultRecord);
  // mark in local sales (optional: set winner flag)
  if(winner){ winner.winner = true; localStorage.setItem(salesKey, JSON.stringify(sales)); renderGrid(); renderAdminSales(); }
}

/* Backup to Web App (POST) */
function sendToWebApp(obj){
  if(!WEB_APP_URL.includes('script.google.com')) return;
  try{
    fetch(WEB_APP_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(obj)
    }).catch(()=>{ /* ignore no-cors limitations, it's still a best-effort backup */ });
  }catch(e){}
}

/* Utilities */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function formatMoney(v){ return 'R$' + Number(v).toFixed(2).replace('.',','); }
function exportCSV(){ if(sales.length===0) return alert('Sem vendas para exportar.'); const header=['number','name','phone','date','paid']; const rows=[header.join(',')].concat(sales.map(s=>[s.number,quoteCsv(s.name),quoteCsv(s.phone),s.date,s.paid].join(','))); const csv=rows.join('\\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='vendas_rifa.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function quoteCsv(s){ return '\"'+String(s).replace(/\"/g,'\"\"')+'\"'; }

/* Admin: fetch sheet backup (optional, best-effort read if your Web App supports GET JSON) */
function fetchSheetBackup(){
  if(!WEB_APP_URL.includes('script.google.com')) return alert('Web App n√£o configurado para leitura.');
  // Try GET - this works only if your Apps Script implements doGet returning JSON.
  fetch(WEB_APP_URL + '?action=list')
    .then(r=>r.json()).then(data=>{
      // expected: array of items {number,name,phone,status,date}
      if(Array.isArray(data)) {
        // merge into local sales if new
        data.forEach(item=>{
          if(!sales.find(s=>s.number===item.number && s.name===item.name)){
            sales.push({ number: item.number, name: item.name, phone: item.phone, date: item.date, paid: (item.status==='Pago') });
          }
        });
        localStorage.setItem(salesKey, JSON.stringify(sales));
        renderGrid(); renderAdminSales();
        alert('Backup sincronizado (dados recebidos).');
      } else alert('Web App n√£o retornou lista (verificar doGet).');
    }).catch(()=>alert('N√£o foi poss√≠vel ler do Web App (verifique permiss√µes/doGet).'));
}

/* simple masking */
function maskPhone(p){ if(!p) return ''; const s = String(p); return s.slice(0,4) + '****' + s.slice(-3); }

/* draw date display updater (no countdown auto-update needed, but simple refresh) */
setInterval(()=>{ loadDrawDateToDisplay(); }, 60000);

/* init */
renderGrid();
</script>
</body>
</html>
